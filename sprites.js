// ============================================
// Sprite System - Pixel Art Sprites (16x16)
// Complete Edition with Party Members & Enemies
// ============================================

// Sprite color palette:
// 0 = transparent, 1 = black, 2 = dark gray, 3 = gray
// 4 = light gray, 5 = white, 6 = red, 7 = dark red
// 8 = green, 9 = dark green, A = blue, B = dark blue
// C = yellow, D = orange, E = pink, F = purple

const SPRITES = {
  characters: {
    hero: {
      down: ["0000033333300000" +
             "0003333333333000" +
             "0003CCCCCCCC3000" +
             "003CCC3333CCC300" +
             "03CCC311113CCC30" +
             "03CC31EE1E13CC30" +
             "03CC31E11E13CC30" +
             "03CCC311113CCC30" +
             "003CCC3663CCC300" +
             "0003AA3333AA3000" +
             "0003AAAAAAAA3000" +
             "003AAAA33AAAA300" +
             "003AAA3333AAA300" +
             "00333334433333000" +
             "0003333003333000" +
             "0003330000333000"],
      up: ["0000033333300000" +
           "0003333333333000" +
           "0003CCCCCCCC3000" +
           "003CCCCCCCCCC300" +
           "03CCCCCCCCCCCC30" +
           "03CCCCCCCCCCCC30" +
           "03CCCCCCCCCCCC30" +
           "03CCCCCCCCCCCC30" +
           "003CCCCCCCCCC300" +
           "0003AA3333AA3000" +
           "0003AAAAAAAA3000" +
           "003AAAA33AAAA300" +
           "003AAA3333AAA300" +
           "00333334433333000" +
           "0003333003333000" +
           "0003330000333000"],
      left: ["0000333333000000" +
             "0003333333330000" +
             "0003CCCCCCC30000" +
             "003CCC3333CC3000" +
             "03CCC31111CCC300" +
             "03CC31EE1E1CC300" +
             "03CC31E11E1CC300" +
             "03CCC31111CCC300" +
             "003CCC3663CC3000" +
             "0003AA3333A30000" +
             "0003AAAAAAA30000" +
             "003AAAA33AAA3000" +
             "003AAA3333AA3000" +
             "003333443333000" +
             "00333300333300" +
             "00333000033300"],
      right: ["0000003333330000" +
              "0000333333333000" +
              "00003CCCCCCC3000" +
              "0003CC3333CCC300" +
              "003CCC11113CCC30" +
              "003CC1E1EE13CC30" +
              "003CC1E11E13CC30" +
              "003CCC11113CCC30" +
              "0003CC3663CCC300" +
              "00003A3333AA3000" +
              "00003AAAAAAA3000" +
              "0003AAA33AAAA300" +
              "003AA3333AAA3000" +
              "003333443333300" +
              "00333300333300" +
              "00333000033300"]
    },
    
    warrior: {
      down: ["0000022222200000" +
             "0002222222222000" +
             "0002777777772000" +
             "0027773333777200" +
             "0277731111377720" +
             "0277311E1E13772" +
             "0277311111137720" +
             "0027773333777200" +
             "0002773333772000" +
             "0002444444442000" +
             "0024444444444200" +
             "0244444444444420" +
             "0244443333444420" +
             "0024443003444200" +
             "0002220000222000" +
             "0002220000222000"],
      up: ["0000022222200000" +
           "0002222222222000" +
           "0002777777772000" +
           "0027777777777200" +
           "0277777777777720" +
           "0277777777777720" +
           "0277777777777720" +
           "0027777777777200" +
           "0002773333772000" +
           "0002444444442000" +
           "0024444444444200" +
           "0244444444444420" +
           "0244443333444420" +
           "0024443003444200" +
           "0002220000222000" +
           "0002220000222000"],
      left: ["0000222222000000" +
             "0002222222220000" +
             "0002777777720000" +
             "0027773333772000" +
             "0277731111777200" +
             "027731EE1E17720" +
             "0277311111772000" +
             "0027773333772000" +
             "0002773333720000" +
             "0002444444420000" +
             "0024444444442000" +
             "0244444444444200" +
             "0244443333444200" +
             "0024443003442000" +
             "0002220000220000" +
             "0002220000220000"],
      right: ["0000002222220000" +
              "0000222222222000" +
              "0000277777772000" +
              "0002773333777200" +
              "0027771111377720" +
              "0027E1EE137772" +
              "0002771111177720" +
              "0002773333777200" +
              "0000273333772000" +
              "0000244444442000" +
              "0002444444444200" +
              "0024444444444420" +
              "0024443333444420" +
              "0002443003444200" +
              "0000220000222000" +
              "0000220000222000"]
    },
    
    mage: {
      down: ["0000FFF333000000" +
             "000FFFFFF333000" +
             "00FFFFFFFF33000" +
             "0FFF5533335F300" +
             "0FF5531111533F0" +
             "0FF5311E1E15FF0" +
             "0FF53111115FF00" +
             "00FF533335FF000" +
             "000FFF333FFF000" +
             "000FFFFFFFF0000" +
             "00FFFFFFFFFF000" +
             "00FFFFF5FFFF000" +
             "00FFFF555FFF000" +
             "000FFF5555FF000" +
             "0000FF000FF0000" +
             "0000FF000FF0000"],
      up: ["0000FFF333000000" +
           "000FFFFFF333000" +
           "00FFFFFFFF33000" +
           "0FFFFFFFFFF3000" +
           "0FFFFFFFFFFFF00" +
           "0FFFFFFFFFFFF00" +
           "0FFFFFFFFFFFF00" +
           "00FFFFFFFFFF000" +
           "000FFF333FFF000" +
           "000FFFFFFFF0000" +
           "00FFFFFFFFFF000" +
           "00FFFFF5FFFF000" +
           "00FFFF555FFF000" +
           "000FFF5555FF000" +
           "0000FF000FF0000" +
           "0000FF000FF0000"],
      left: ["0000FFF33300000" +
             "000FFFFFF330000" +
             "00FFFFFFFF3000" +
             "0FFF55333FF0000" +
             "0FF553111FFF000" +
             "0FF531EE1FF0000" +
             "0FF53111FF00000" +
             "00FF5333FF00000" +
             "000FFF3FFF00000" +
             "000FFFFFF000000" +
             "00FFFFFFFF00000" +
             "00FFFF5FFF00000" +
             "00FFF555FF00000" +
             "000FF555F000000" +
             "0000FF0FF000000" +
             "0000FF0FF000000"],
      right: ["00000333FFF0000" +
              "0000033FFFFFF00" +
              "00003FFFFFFFF0" +
              "0000FF333555FF0" +
              "000FFF111355FF0" +
              "0000FF1EE135FF0" +
              "00000FF11135FF0" +
              "00000FF3335FF00" +
              "00000FFF3FFF000" +
              "000000FFFFFF000" +
              "00000FFFFFFFF00" +
              "00000FFF5FFFF00" +
              "00000FF555FFF00" +
              "000000F555FF000" +
              "000000FF0FF0000" +
              "000000FF0FF0000"]
    },
    
    healer: {
      down: ["0000055555500000" +
             "0005555555555000" +
             "0005555555555000" +
             "0055553333555500" +
             "0555531111355550" +
             "055531E61E1355500" +
             "0555311111355500" +
             "0055553333555000" +
             "0005555555550000" +
             "0005555555550000" +
             "0055555555555000" +
             "0555556665555500" +
             "0555566666555500" +
             "0055556665555000" +
             "0005550005550000" +
             "0005550005550000"],
      up: ["0000055555500000" +
           "0005555555555000" +
           "0005555555555000" +
           "0055555555555500" +
           "0555555555555550" +
           "0555555555555550" +
           "0555555555555500" +
           "0055555555555000" +
           "0005555555550000" +
           "0005555555550000" +
           "0055555555555000" +
           "0555556665555500" +
           "0555566666555500" +
           "0055556665555000" +
           "0005550005550000" +
           "0005550005550000"],
      left: ["0000555555000000" +
             "0005555555550000" +
             "0005555555550000" +
             "0055553333555000" +
             "0555531111555500" +
             "055531EE1E15550" +
             "0555311111555000" +
             "0055553333555000" +
             "0005555555550000" +
             "0005555555500000" +
             "0055555555500000" +
             "0555556665550000" +
             "0555566666550000" +
             "0055556665550000" +
             "0005550005500000" +
             "0005550005500000"],
      right: ["0000005555550000" +
              "0000555555555000" +
              "0000555555555000" +
              "0005553333555500" +
              "0055551111355550" +
              "05551E1EE135550" +
              "0005551111135550" +
              "0005553333555500" +
              "0000555555555000" +
              "0000055555555000" +
              "0000055555555000" +
              "0000556665555500" +
              "0000566666555500" +
              "0000556665555000" +
              "0000055000555000" +
              "0000055000555000"]
    },
    
    king: {
      down: ["000CC00000CC0000" +
             "000CCCCCCCC0000" +
             "00CCCCCCCCC0000" +
             "0CCCCCCCCCCC000" +
             "0CC33333333CC00" +
             "0C3331111333C00" +
             "0C331E11E133C00" +
             "0C333111133C000" +
             "00C33666633C000" +
             "00CCC3333CC0000" +
             "000FFFFFFF00000" +
             "00FFFFFFFFF0000" +
             "00FFFFFFFFF0000" +
             "000FFFFFFF00000" +
             "000FF000FF00000" +
             "000FF000FF00000"]
    },
    
    princess: {
      down: ["0000EEEEEE00000" +
             "000EEEEEEEE0000" +
             "00EEEEEEEEEE000" +
             "0EEEE3333EEEE00" +
             "0EEE311113EEE00" +
             "0EE311E1E113EE0" +
             "0EE31111113EE00" +
             "0EEE333663EEE00" +
             "00EEE3333EEE000" +
             "000EEEEEEEE0000" +
             "00EEEEEEEEEE000" +
             "00EEEE55EEEE000" +
             "00EEE5555EEE000" +
             "00EE555555EE000" +
             "00EE500005EE000" +
             "00EE500005EE000"]
    },
    
    guard: {
      down: ["0000044444400000" +
             "0004444444444000" +
             "0004222222224000" +
             "0042223333222400" +
             "0422231111322240" +
             "042231E11E13224" +
             "0422311111322400" +
             "0042223333222400" +
             "0004223333224000" +
             "0004444444440000" +
             "0044444444444000" +
             "0444444444444400" +
             "0444443333444400" +
             "0044443003444000" +
             "0004440000444000" +
             "0004440000444000"]
    },
    
    maid: {
      down: ["0000022222200000" +
             "0002222222222000" +
             "0002255555522000" +
             "0025553333555200" +
             "0255531111355520" +
             "025531E11E13552" +
             "0255311111355200" +
             "0025553333555200" +
             "0002553333552000" +
             "0002222222220000" +
             "0022222222222000" +
             "0222225555222200" +
             "0222255555522200" +
             "0022225555222000" +
             "0002220000222000" +
             "0002220000222000"]
    },
    
    merchant: {
      down: ["0000077777700000" +
             "0007777777777000" +
             "0007733333377000" +
             "0077333333337700" +
             "0773331111333770" +
             "077331E11E13377" +
             "0773311111333700" +
             "0077333333337000" +
             "0007733333770000" +
             "0007777777770000" +
             "0077777777777000" +
             "0777777777777700" +
             "0777773333777700" +
             "0077773003777000" +
             "0007770000777000" +
             "0007770000777000"]
    },
    
    villager: {
      down: ["0000033333300000" +
             "0003333333333000" +
             "0003333333333000" +
             "0033333333333300" +
             "0333331111333330" +
             "033331E11E13333" +
             "0333311111333300" +
             "0033333333333000" +
             "0003333663330000" +
             "0003999999930000" +
             "0039999999993000" +
             "0399999999999300" +
             "0399993333999300" +
             "0039993003999000" +
             "0003990000993000" +
             "0003990000993000"]
    },
    
    oldman: {
      down: ["0000055555500000" +
             "0005555555555000" +
             "0055555555555500" +
             "0555553333555550" +
             "0555531111355550" +
             "055531E11E13555" +
             "0555311111355500" +
             "0555533333355000" +
             "0055555555550000" +
             "0005555555500000" +
             "0055577775550000" +
             "0557777777755000" +
             "0557773337755000" +
             "0055773037750000" +
             "0005770007700000" +
             "0005770007700000"]
    },
    
    cat: {
      down: ["0000000000000000" +
             "0000000000000000" +
             "0DD00000000DD000" +
             "0DDD000000DDD000" +
             "0DDDDDDDDDDD0000" +
             "0DD1DD00DD1DD000" +
             "0DDDDD00DDDDD000" +
             "0DDDD6DD6DDDD000" +
             "0DDDDDDDDDDD0000" +
             "00DDDDDDDDD00000" +
             "000DDDDDDD000000" +
             "0000DDDDD0000000" +
             "00DDDDDDDDD00000" +
             "0DDDDDDDDDDD0000" +
             "0DDDDD00DDDDD000" +
             "0000000000000000"]
    }
  },
  
  enemies: {
    slime: ["0000000000000000" +
            "0000008888000000" +
            "0000888888880000" +
            "0008888888888000" +
            "0088855885588800" +
            "0088855885588800" +
            "0888885588888880" +
            "0888888888888880" +
            "8888888888888888" +
            "8888888888888888" +
            "8888888888888888" +
            "0888888888888880" +
            "0088888888888800" +
            "0008888888888000" +
            "0000888888880000" +
            "0000000000000000"],
    
    goblin: ["0000099999900000" +
             "0009999999990000" +
             "0099333333990000" +
             "0993331113339000" +
             "099311E1E1139900" +
             "0993111111339000" +
             "0099333663990000" +
             "0009933339900000" +
             "0009999999990000" +
             "0009933339990000" +
             "0099933339990000" +
             "0993333333990000" +
             "0993330033990000" +
             "0099330033900000" +
             "0009930039900000" +
             "0000990009900000"],
    
    bat: ["0000000000000000" +
          "0220000000000220" +
          "2222000000002222" +
          "2222200000022222" +
          "2222222222222222" +
          "2221112222111222" +
          "2221612226162222" +
          "0222222222222220" +
          "0022222222222200" +
          "0002222222222000" +
          "0000222222220000" +
          "0000022222200000" +
          "0000022002200000" +
          "0000220000220000" +
          "0000000000000000" +
          "0000000000000000"],
    
    skeleton: ["0000055555500000" +
               "0005555555550000" +
               "0055511111555000" +
               "0551111111155000" +
               "0551011110155000" +
               "0551111111155000" +
               "0055111111550000" +
               "0005555555500000" +
               "0000555555000000" +
               "0055555555550000" +
               "0505555555505000" +
               "0005555555500000" +
               "0000555555000000" +
               "0000555555000000" +
               "0000550055000000" +
               "0000550055000000"],
    
    orc: ["0000099999900000" +
          "0009999999990000" +
          "0099999999999000" +
          "0999933339999900" +
          "0999311113999900" +
          "099311E1E1139990" +
          "0993111111339900" +
          "0999333663999000" +
          "0099933339990000" +
          "0999999999999000" +
          "0999944449999000" +
          "0994444444499000" +
          "0994443344499000" +
          "0099443034490000" +
          "0009940049900000" +
          "0000990009900000"],
    
    dark_mage: ["00FF000000FF0000" +
                "0FFFF0000FFFF000" +
                "0FFFFFFFF1FFF000" +
                "0F11333331FFF000" +
                "0F1331113F1F0000" +
                "0F131E1E1311F000" +
                "0F133111133F0000" +
                "0F133336331F0000" +
                "00F1333331F00000" +
                "00FFFFFFFF000000" +
                "00FFFFFFFF000000" +
                "0FFFFFFFFFF00000" +
                "0FFFFFFFFFFF0000" +
                "00FFFFFFFFFF0000" +
                "000FFF00FFF00000" +
                "000FFF00FFF00000"],
    
    golem: ["0044444444444400" +
            "0444444444444440" +
            "4444411114444444" +
            "4444166614444444" +
            "4444111114444444" +
            "4444444444444444" +
            "0444444444444440" +
            "0444444444444440" +
            "4444444444444444" +
            "4444444444444444" +
            "4444444444444444" +
            "0444444444444440" +
            "0444400004444400" +
            "0444400004444400" +
            "0044440044440000" +
            "0044440044440000"],
    
    dark_knight: ["0000022222200000" +
                  "0002222222222000" +
                  "0002222222222000" +
                  "0022221111222200" +
                  "0222216661122220" +
                  "0222211111122220" +
                  "0022222222222200" +
                  "0002222222222000" +
                  "0022222222222200" +
                  "0222222222222220" +
                  "2222222222222222" +
                  "2222224442222222" +
                  "0222244442222220" +
                  "0022244442222200" +
                  "0002220002222000" +
                  "0002220002222000"],
    
    demon_lord: ["0066000000006600" +
                 "0666600000066600" +
                 "6666662222666666" +
                 "6662222222226666" +
                 "0622111111122600" +
                 "062116661161260" +
                 "0622111111122600" +
                 "0622266662226000" +
                 "0062222222226000" +
                 "0666666666666600" +
                 "0666266666626600" +
                 "6666666666666660" +
                 "6666662266666660" +
                 "0666662266666600" +
                 "0066660066660000" +
                 "0066660066660000"]
  },
  
  tiles: {
    // Ground tiles
    grass: ["8888888888888888" +
            "8988898888889888" +
            "8888888898888888" +
            "8888888888888888" +
            "8898888888888898" +
            "8888888888888888" +
            "8888888988888888" +
            "8888888888888888" +
            "8888988888888888" +
            "8888888888898888" +
            "8888888888888888" +
            "8898888888888888" +
            "8888888888888888" +
            "8888888898888888" +
            "8888888888888898" +
            "8888888888888888"],
    
    stone: ["4444344443444434" +
            "4434444434444344" +
            "3444444444443444" +
            "4444434444444444" +
            "4444444443444434" +
            "4343444444444444" +
            "4444444444344444" +
            "4444344444444434" +
            "4344444444444444" +
            "4444444434444344" +
            "4444434444444444" +
            "4434444444343444" +
            "4444444444444444" +
            "4444444434444444" +
            "4343444444444344" +
            "4444444444444444"],
    
    wall: ["2222222222222222" +
           "2333333333333332" +
           "2333333333333332" +
           "2333333333333332" +
           "2222222222222222" +
           "3332233333322333" +
           "3332233333322333" +
           "3332233333322333" +
           "2222222222222222" +
           "2333333333333332" +
           "2333333333333332" +
           "2333333333333332" +
           "2222222222222222" +
           "3333322333332233" +
           "3333322333332233" +
           "2222222222222222"],
    
    floor: ["4444444444444444" +
            "4555555555555554" +
            "4555555555555554" +
            "4555555555555554" +
            "4555555555555554" +
            "4555555555555554" +
            "4555555555555554" +
            "4444444444444444" +
            "4444444444444444" +
            "4555555555555554" +
            "4555555555555554" +
            "4555555555555554" +
            "4555555555555554" +
            "4555555555555554" +
            "4555555555555554" +
            "4444444444444444"],
    
    water: ["AAAAAAAAAAAAAAAA" +
            "AAABBAAAAABBAAAA" +
            "AAAAABBAAAAAABBA" +
            "AAAAAAAAAAAAAAAA" +
            "ABBAAAAAABBAAAAA" +
            "AAABBAAAAAABBAA" +
            "AAAAAAAAAAAAAAAA" +
            "AAAAAABBAAAAAABB" +
            "AAAAAAAAAAAAAAAA" +
            "AABBAAAAAABBAAAA" +
            "AAAABBAAAAAABBA" +
            "AAAAAAAAAAAAAAAA" +
            "AAAAAABBAAAAAABB" +
            "AAAAAAAAAAAAAAA" +
            "ABBAAAAAABBAAAAA" +
            "AAABBAAAAAABBAA"],
    
    carpet: ["6666666666666666" +
             "6C66666666666C66" +
             "6666666666666666" +
             "6666666666666666" +
             "6666666666666666" +
             "6666666666666666" +
             "6666666666666666" +
             "6C66666666666C66" +
             "6C66666666666C66" +
             "6666666666666666" +
             "6666666666666666" +
             "6666666666666666" +
             "6666666666666666" +
             "6666666666666666" +
             "6C66666666666C66" +
             "6666666666666666"],
    
    tree: ["0000888888880000" +
           "0088888888888800" +
           "0888888888888880" +
           "8888888888888888" +
           "8888888888888888" +
           "0888888888888880" +
           "0088888888888800" +
           "0000777777770000" +
           "0000077777700000" +
           "0000007777000000" +
           "0000007777000000" +
           "0000007777000000" +
           "0000007777000000" +
           "0000007777000000" +
           "0000077777700000" +
           "0000777777770000"],
    
    pot: ["0000000000000000" +
          "0000000000000000" +
          "0000777777000000" +
          "0007777777700000" +
          "0077333337770000" +
          "0773333333770000" +
          "0773333333770000" +
          "0773333333770000" +
          "0773333333770000" +
          "0773333333770000" +
          "0773333333770000" +
          "0077333337700000" +
          "0007777777000000" +
          "0000777770000000" +
          "0000000000000000" +
          "0000000000000000"],
    
    chest: ["0000000000000000" +
            "0000000000000000" +
            "0077777777777000" +
            "0777777777777700" +
            "07CCCCCCCCCCC700" +
            "07CCCCCCCCCCC700" +
            "0777777777777700" +
            "07DDDDDDDDDDD700" +
            "07DDDDCCCDDDD700" +
            "07DDDDCCCDDDD700" +
            "07DDDDDDDDDDD700" +
            "07DDDDDDDDDDD700" +
            "0777777777777700" +
            "0077777777777000" +
            "0000000000000000" +
            "0000000000000000"],
    
    sparkle: ["0000000C00000000" +
              "000000CCC0000000" +
              "0000000C00000000" +
              "0000000000000000" +
              "00C000000000C000" +
              "0CCC0000000CCC00" +
              "00C000000000C000" +
              "0000000000000000" +
              "0000000000000000" +
              "00C000000000C000" +
              "0CCC0000000CCC00" +
              "00C000000000C000" +
              "0000000000000000" +
              "0000000C00000000" +
              "000000CCC0000000" +
              "0000000C00000000"],
    
    exit_arrow: ["0000000000000000" +
                 "0000008880000000" +
                 "0000088888000000" +
                 "0000888888800000" +
                 "0008888888880000" +
                 "0088888888888000" +
                 "0000088888000000" +
                 "0000088888000000" +
                 "0000088888000000" +
                 "0000088888000000" +
                 "0000088888000000" +
                 "0000088888000000" +
                 "0000088888000000" +
                 "0000000000000000" +
                 "0000000000000000" +
                 "0000000000000000"],
    
    tower_wall: ["1111111111111111" +
                 "1222222222222221" +
                 "1222222222222221" +
                 "1222222222222221" +
                 "1111111111111111" +
                 "2221122222211222" +
                 "2221122222211222" +
                 "2221122222211222" +
                 "1111111111111111" +
                 "1222222222222221" +
                 "1222222222222221" +
                 "1222222222222221" +
                 "1111111111111111" +
                 "2222211222221122" +
                 "2222211222221122" +
                 "1111111111111111"],
    
    tower_floor: ["2222222222222222" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2222222222222222" +
                  "2222222222222222" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2222222222222222"]
  }
};

// Sprite rendering class
class SpriteRenderer {
  constructor() {
    this.cache = {};
    this.animFrame = 0;
    this.lastAnimTime = 0;
  }
  
  updateAnimation(time) {
    if (time - this.lastAnimTime > 500) {
      this.animFrame = (this.animFrame + 1) % 2;
      this.lastAnimTime = time;
    }
  }
  
  getSprite(spriteData, scale = 1) {
    const key = spriteData + `-${scale}`;
    if (this.cache[key]) {
      return this.cache[key];
    }
    
    const size = 16;
    const canvas = document.createElement('canvas');
    canvas.width = size * scale;
    canvas.height = size * scale;
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    
    const colors = {
      "0": "transparent",
      "1": "#000000",
      "2": "#333333",
      "3": "#555555",
      "4": "#888888",
      "5": "#EEEECC",
      "6": "#FF3333",
      "7": "#884400",
      "8": "#44AA44",
      "9": "#449944",
      "A": "#4488FF",
      "B": "#3366CC",
      "C": "#FFCC00",
      "D": "#FF8800",
      "E": "#111111",
      "F": "#8844AA"
    };
    
    for (let y = 0; y < size; y++) {
      for (let x = 0; x < size; x++) {
        const char = spriteData[y * size + x];
        const color = colors[char];
        if (color && color !== "transparent") {
          ctx.fillStyle = color;
          ctx.fillRect(x * scale, y * scale, scale, scale);
        }
      }
    }
    
    this.cache[key] = canvas;
    return canvas;
  }
  
  getCharacterSprite(spriteKey, direction = 'down', scale = 1) {
    const spriteData = SPRITES.characters[spriteKey]?.[direction];
    if (!spriteData) {
      console.warn(`Character sprite not found: ${spriteKey} ${direction}`);
      return null;
    }
    return this.getSprite(spriteData[0], scale);
  }
  
  getEnemySprite(enemyId, scale = 1) {
    const spriteData = SPRITES.enemies[enemyId];
    if (!spriteData) {
      console.warn(`Enemy sprite not found: ${enemyId}`);
      return null;
    }
    return this.getSprite(spriteData[0] || spriteData, scale);
  }
  
  getTileSprite(tileId, scale = 1) {
    const spriteData = SPRITES.tiles[tileId];
    if (!spriteData) {
      return null;
    }
    return this.getSprite(spriteData, scale);
  }
  
  generateMapBackground(mapData, scale = 2) {
    const tileSize = 16;
    const canvas = document.createElement('canvas');
    canvas.width = mapData.size.w * tileSize * scale;
    canvas.height = mapData.size.h * tileSize * scale;
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    
    // Determine base tile based on map type
    let baseTile = 'floor';
    let wallTile = 'wall';
    
    if (mapData.tileData === 'field') {
      baseTile = 'grass';
      wallTile = 'tree';
    } else if (mapData.tileData === 'tower_inside' || mapData.tileData === 'tower_outside') {
      baseTile = 'tower_floor';
      wallTile = 'tower_wall';
    } else if (mapData.tileData === 'throne') {
      baseTile = 'carpet';
      wallTile = 'wall';
    } else if (mapData.tileData === 'town') {
      baseTile = 'stone';
      wallTile = 'wall';
    }
    
    // Draw tiles based on collision
    for (let y = 0; y < mapData.size.h; y++) {
      for (let x = 0; x < mapData.size.w; x++) {
        const collision = mapData.collision[y]?.[x] || 0;
        const tileId = collision === 1 ? wallTile : baseTile;
        const sprite = this.getTileSprite(tileId, scale);
        if (sprite) {
          ctx.drawImage(sprite, x * tileSize * scale, y * tileSize * scale);
        }
      }
    }
    
    return canvas;
  }
}

window.SPRITES = SPRITES;
window.SpriteRenderer = SpriteRenderer;

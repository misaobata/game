// ============================================
// Sprite Generator - Pixel Art Definitions
// Enhanced with more characters and tiles
// ============================================

const SPRITES = {
  // Character sprites (16x16 pixel art as 2D arrays)
  // 0 = transparent, other numbers = color palette index
  
  characters: {
    hero: {
      down: [
        "....4444....",
        "...444444...",
        "..44444444..",
        "..4F4FF4F4..",
        "..44FFFF44..",
        "..44F00F44..",
        "...4FFFF4...",
        "....6666....",
        "...666666...",
        "..66622666..",
        "..66622666..",
        "..66666666..",
        "...66..66...",
        "..666..666..",
        "..555..555..",
        "..555..555.."
      ],
      up: [
        "....4444....",
        "...444444...",
        "..44444444..",
        "..44444444..",
        "..44444444..",
        "..44444444..",
        "...444444...",
        "....6666....",
        "...666666...",
        "..66622666..",
        "..66622666..",
        "..66666666..",
        "...66..66...",
        "..666..666..",
        "..555..555..",
        "..555..555.."
      ],
      left: [
        "....4444....",
        "...444444...",
        "..44444444..",
        "..4F44F444..",
        "..4FFF4444..",
        "..4F0F4444..",
        "...4FFF4....",
        "....6666....",
        "...666666...",
        "..66226666..",
        "..66226666..",
        "..66666666..",
        "...66..66...",
        "..666..666..",
        "..555..555..",
        "..555..555.."
      ],
      right: [
        "....4444....",
        "...444444...",
        "..44444444..",
        "..444F44F4..",
        "..4444FFF4..",
        "..4444F0F4..",
        "...4FFF4....",
        "....6666....",
        "...666666...",
        "..66666226..",
        "..66666226..",
        "..66666666..",
        "...66..66...",
        "..666..666..",
        "..555..555..",
        "..555..555.."
      ]
    },
    
    king: {
      down: [
        "...EEEEEE...",
        "..E7E77E7E..",
        "..EEEEEEEE..",
        "...EEEEEE...",
        "..EF4FF4FE..",
        "..E44FF44E..",
        "..E4F00F4E..",
        "...EFFFFE...",
        "....9999....",
        "...999999...",
        "..99999999..",
        "..99999999..",
        "..99999999..",
        "...99..99...",
        "..999..999..",
        "..555..555.."
      ]
    },
    
    princess: {
      down: [
        "....EEEE....",
        "...E7EE7E...",
        "..EEEEEEEE..",
        "..EAAAAAAE..",
        "..AFAFFAFA..",
        "..AAFFFFAA..",
        "..AAF00FAA..",
        "...AFFFFA...",
        "....CCCC....",
        "...CCCCCC...",
        "..CCCCCCCC..",
        "..CCCCCCCC..",
        "..CCCCCCCC..",
        "..CCCCCCCC..",
        "...CCCCCC...",
        "....FFFF...."
      ]
    },
    
    guard: {
      down: [
        "....7777....",
        "...777777...",
        "..77777777..",
        "..7F7FF7F7..",
        "..77FFFF77..",
        "..77F00F77..",
        "...7FFFF7...",
        "....BBBB....",
        "...BBBBBB...",
        "..BBBBBBBB..",
        "..BB7777BB..",
        "..BBBBBBBB..",
        "...BB..BB...",
        "..BBB..BBB..",
        "..777..777..",
        "..777..777.."
      ]
    },
    
    maid: {
      down: [
        "....5555....",
        "...555555...",
        "..55FFFF55..",
        "..5FFFFFF5..",
        "..FFFFFFFF..",
        "..FFF00FFF..",
        "...FFFFFF...",
        "....1111....",
        "...111111...",
        "..1111F111..",
        "..11111111..",
        "..11111111..",
        "..11111111..",
        "...11..11...",
        "..111..111..",
        "..555..555.."
      ]
    },
    
    merchant: {
      down: [
        "....8888....",
        "...888888...",
        "..88888888..",
        "..8F8FF8F8..",
        "..88FFFF88..",
        "..88F00F88..",
        "...8FFFF8...",
        "....EEEE....",
        "...EEEEEE...",
        "..EEEEEEEE..",
        "..EE5555EE..",
        "..EEEEEEEE..",
        "...EE..EE...",
        "..EEE..EEE..",
        "..555..555..",
        "..555..555.."
      ]
    },
    
    villager: {
      down: [
        "............",
        "....5555....",
        "...555555...",
        "..55555555..",
        "..5F5FF5F5..",
        "..55FFFF55..",
        "..55F00F55..",
        "...5FFFF5...",
        "....8888....",
        "...888888...",
        "..88888888..",
        "..88888888..",
        "..88888888..",
        "...88..88...",
        "..555..555..",
        "..555..555.."
      ]
    },
    
    oldman: {
      down: [
        "............",
        "....7777....",
        "...777777...",
        "..77777777..",
        "..7F7FF7F7..",
        "..77FFFF77..",
        "..77F00F77..",
        "...7FFFF7...",
        "....8888....",
        "...888888...",
        "..88888888..",
        "..88888888..",
        "..88888888..",
        "...88..88...",
        "..888..888..",
        "..555..555.."
      ]
    },
    
    cat: {
      down: [
        "................",
        "................",
        "................",
        "................",
        "................",
        "....EE....EE....",
        "...EEEE..EEEE...",
        "..EEEEEEEEEEEE..",
        "..EE0EEEEEE0EE..",
        "..EEEEEFFEEEE E..",
        "..EEEEEEEEEEEE..",
        "...EEEEEEEEEE...",
        "....EEEEEEEE....",
        ".....EEEEEE.....",
        "......EEEE......",
        "................"
      ]
    }
  },
  
  enemies: {
    slime: [
      "................",
      "................",
      "................",
      "................",
      "......3333......",
      "....33333333....",
      "...3333333333...",
      "..333F3333F333..",
      "..333033330333..",
      "..333333333333..",
      ".33333333333333.",
      ".33333FFFF33333.",
      ".33333333333333.",
      "..333333333333..",
      "...3333333333...",
      "................"
    ],
    
    goblin: [
      "................",
      "....33333333....",
      "...3333333333...",
      "..33F333333F33..",
      "..330333333033..",
      "..333333333333..",
      "..33333FF33333..",
      "...3333333333...",
      "....88888888....",
      "...8888888888...",
      "..888888888888..",
      "..888822228888..",
      "...8888888888...",
      "....88....88....",
      "...888....888...",
      "...555....555..."
    ],
    
    bat: [
      "................",
      "................",
      "..1..........1..",
      ".111........111.",
      "11111......11111",
      "111111111111111 1",
      ".1111111111111 1.",
      "..11111111111 1..",
      "...111F11F111...",
      "...1110110111...",
      "....11111111....",
      ".....111111.....",
      "......1111......",
      "................",
      "................",
      "................"
    ],
    
    skeleton: [
      "................",
      ".....777777.....",
      "....77777777....",
      "...77F7777F77...",
      "...7707777077...",
      "...7777777777...",
      "....77FFFF77....",
      ".....777777.....",
      "......7777......",
      "....77777777....",
      "...7777777777...",
      "....77777777....",
      ".....77..77.....",
      "....777..777....",
      "....777..777....",
      "................"
    ],
    
    dark_knight: [
      ".....111111.....",
      "....11111111....",
      "...1111111111...",
      "..111F1111F111..",
      "..111011110111..",
      "..111111111111..",
      "..1111FFFF1111..",
      "...1111111111...",
      "....22222222....",
      "...2222222222...",
      "..222222222222..",
      "..221111112222..",
      "..222222222222..",
      "...2222222222...",
      "..2222....2222..",
      "..1111....1111.."
    ]
  },
  
  // Smaller map sprites for visible monsters (8x8)
  mapMonsters: {
    slime_map: [
      "..3333..",
      ".333333.",
      "33F33F33",
      "33033033",
      "33333333",
      "33FFFF33",
      ".333333.",
      "..3333.."
    ],
    goblin_map: [
      ".333333.",
      "33F33F33",
      "33033033",
      "3333FF33",
      ".888888.",
      "88822888",
      ".88..88.",
      ".55..55."
    ],
    bat_map: [
      "1......1",
      "11....11",
      "11111111",
      ".111111.",
      "..1FF1..",
      "..1001..",
      "...11...",
      "........"
    ],
    skeleton_map: [
      "..7777..",
      ".7F77F7.",
      ".707707.",
      ".777777.",
      "..7FF7..",
      ".777777.",
      "..7..7..",
      ".77..77."
    ]
  },
  
  tiles: {
    grass: {
      base: '3',
      pattern: [
        "3333333333333333",
        "3323333333333333",
        "3333333332333333",
        "3333333333333333",
        "3333323333333333",
        "3333333333333233",
        "3333333333333333",
        "3333333333333333",
        "3332333333333333",
        "3333333333323333",
        "3333333333333333",
        "3333333333333333",
        "3333333333333333",
        "3233333333333333",
        "3333333233333333",
        "3333333333333333"
      ]
    },
    
    wall: {
      base: '5',
      pattern: [
        "5555555555555555",
        "5666566656665666",
        "5666566656665666",
        "5555555555555555",
        "6655566555655565",
        "6655566555655565",
        "5555555555555555",
        "5666566656665666",
        "5666566656665666",
        "5555555555555555",
        "6655566555655565",
        "6655566555655565",
        "5555555555555555",
        "5666566656665666",
        "5666566656665666",
        "5555555555555555"
      ]
    },
    
    castle_floor: {
      pattern: [
        "8888888877777777",
        "8888888877777777",
        "8888888877777777",
        "8888888877777777",
        "8888888877777777",
        "8888888877777777",
        "8888888877777777",
        "8888888877777777",
        "7777777788888888",
        "7777777788888888",
        "7777777788888888",
        "7777777788888888",
        "7777777788888888",
        "7777777788888888",
        "7777777788888888",
        "7777777788888888"
      ]
    },
    
    castle_wall: {
      pattern: [
        "6666666666666666",
        "6555655565556555",
        "6555655565556555",
        "6666666666666666",
        "5566655665566556",
        "5566655665566556",
        "6666666666666666",
        "6555655565556555",
        "6555655565556555",
        "6666666666666666",
        "5566655665566556",
        "5566655665566556",
        "6666666666666666",
        "6555655565556555",
        "6555655565556555",
        "6666666666666666"
      ]
    },
    
    throne_floor: {
      pattern: [
        "9999999988888888",
        "9777779988888888",
        "9777779988888888",
        "9777779988888888",
        "9999999988888888",
        "8888888899999999",
        "8888888897777799",
        "8888888897777799",
        "8888888897777799",
        "8888888899999999",
        "9999999988888888",
        "9777779988888888",
        "9777779988888888",
        "9777779988888888",
        "9999999988888888",
        "8888888888888888"
      ]
    },
    
    town_floor: {
      pattern: [
        "6666666666666666",
        "6555555555555556",
        "6555555555555556",
        "6555555555555556",
        "6555555555555556",
        "6555555555555556",
        "6555555555555556",
        "6666666666666666",
        "6666666666666666",
        "6555555555555556",
        "6555555555555556",
        "6555555555555556",
        "6555555555555556",
        "6555555555555556",
        "6555555555555556",
        "6666666666666666"
      ]
    },
    
    town_wall: {
      pattern: [
        "5858585858585858",
        "8585858585858585",
        "5858585858585858",
        "8585858585858585",
        "5858585858585858",
        "8585858585858585",
        "5858585858585858",
        "8585858585858585",
        "5858585858585858",
        "8585858585858585",
        "5858585858585858",
        "8585858585858585",
        "5858585858585858",
        "8585858585858585",
        "5858585858585858",
        "8585858585858585"
      ]
    },
    
    field_grass: {
      pattern: [
        "3333333333333333",
        "3323333323333333",
        "3333233333323333",
        "3333333333333333",
        "3332333333333233",
        "3333333323333333",
        "3333333333333333",
        "3323333333333333",
        "3333333333323333",
        "3333323333333333",
        "3333333333333333",
        "3233333333333233",
        "3333333323333333",
        "3333333333333333",
        "3333233333333333",
        "3333333333323333"
      ]
    },
    
    field_tree: {
      pattern: [
        "....33333333....",
        "...3333333333...",
        "..333333333333..",
        ".33333333333333.",
        ".33333333333333.",
        "3333333333333333",
        "3333333333333333",
        ".33333333333333.",
        "..333355553333..",
        "......5555......",
        "......5555......",
        "......5555......",
        "......5555......",
        "......5555......",
        ".....555555.....",
        "....55555555...."
      ]
    },
    
    tower_floor: {
      pattern: [
        "1111111111111111",
        "1222122212221222",
        "1222122212221222",
        "1111111111111111",
        "2211122111211121",
        "2211122111211121",
        "1111111111111111",
        "1222122212221222",
        "1222122212221222",
        "1111111111111111",
        "2211122111211121",
        "2211122111211121",
        "1111111111111111",
        "1222122212221222",
        "1222122212221222",
        "1111111111111111"
      ]
    },
    
    tower_wall: {
      pattern: [
        "1111111111111111",
        "1222222222222221",
        "1222222222222221",
        "1111111111111111",
        "1222222222222221",
        "1222222222222221",
        "1111111111111111",
        "1222222222222221",
        "1222222222222221",
        "1111111111111111",
        "1222222222222221",
        "1222222222222221",
        "1111111111111111",
        "1222222222222221",
        "1222222222222221",
        "1111111111111111"
      ]
    },
    
    chest: [
      "................",
      "................",
      "................",
      "................",
      "..EEEEEEEEEEEE..",
      "..E7777777777E..",
      "..EEEEEEEEEEEE..",
      "..EEEEEEEEEEEE..",
      "..E5555555555E..",
      "..E5555E55555E..",
      "..E5555E55555E..",
      "..E5555555555E..",
      "..EEEEEEEEEEEE..",
      "................",
      "................",
      "................"
    ],
    
    chest_open: [
      "..EEEEEEEEEEEE..",
      "..E7777777777E..",
      "..E7777777777E..",
      "..EEEEEEEEEEEE..",
      "..EEEEEEEEEEEE..",
      "..E5555555555E..",
      "..E5555555555E..",
      "..E5555555555E..",
      "..E5555555555E..",
      "..E5555555555E..",
      "..E5555555555E..",
      "..E5555555555E..",
      "..EEEEEEEEEEEE..",
      "................",
      "................",
      "................"
    ],
    
    pot: [
      "................",
      "................",
      "................",
      "................",
      "......5555......",
      ".....555555.....",
      "....55888855....",
      "...5588888855...",
      "...5588888855...",
      "...5588888855...",
      "...5588888855...",
      "....55888855....",
      ".....555555.....",
      "......5555......",
      "................",
      "................"
    ],
    
    sparkle: [
      "................",
      "................",
      "................",
      ".......E........",
      "......EEE.......",
      ".....EEEEE......",
      "......EEE.......",
      ".......E........",
      "................",
      "................",
      "................",
      "................",
      "................",
      "................",
      "................",
      "................"
    ],
    
    exit_arrow: [
      "................",
      "................",
      "................",
      "......EE........",
      ".....EEE........",
      "....EEEE........",
      "...EEEEEEEEEEE..",
      "..EEEEEEEEEEEE..",
      "..EEEEEEEEEEEE..",
      "...EEEEEEEEEEE..",
      "....EEEE........",
      ".....EEE........",
      "......EE........",
      "................",
      "................",
      "................"
    ]
  },
  
  // Color palette
  palette: {
    '0': '#000000', // Black
    '1': '#2c2137', // Dark purple
    '2': '#764462', // Purple
    '3': '#4b8056', // Green (grass)
    '4': '#e8b749', // Yellow/Gold (hero hair)
    '5': '#8b6b4a', // Brown
    '6': '#c4a35a', // Tan/beige
    '7': '#a8a8a8', // Light gray
    '8': '#6b5344', // Dark brown
    '9': '#9b2335', // Red (king robe)
    'A': '#e85d9c', // Pink (princess hair)
    'B': '#5b8fc9', // Blue
    'C': '#d17ac1', // Light pink (princess dress)
    'D': '#52c33f', // Bright green
    'E': '#ffe478', // Gold/Yellow
    'F': '#ffccaa', // Skin tone
    '.': 'transparent'
  }
};

// Sprite rendering class
class SpriteRenderer {
  constructor(palette = SPRITES.palette) {
    this.palette = palette;
    this.cache = new Map();
  }
  
  // Create canvas from pixel art string array
  createSprite(pixelData, scale = 1) {
    const cacheKey = JSON.stringify(pixelData) + scale;
    if (this.cache.has(cacheKey)) {
      return this.cache.get(cacheKey);
    }
    
    const height = pixelData.length;
    const width = pixelData[0].length;
    
    const canvas = document.createElement('canvas');
    canvas.width = width * scale;
    canvas.height = height * scale;
    const ctx = canvas.getContext('2d');
    
    ctx.imageSmoothingEnabled = false;
    
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const colorKey = pixelData[y][x];
        const color = this.palette[colorKey];
        
        if (color && color !== 'transparent') {
          ctx.fillStyle = color;
          ctx.fillRect(x * scale, y * scale, scale, scale);
        }
      }
    }
    
    this.cache.set(cacheKey, canvas);
    return canvas;
  }
  
  // Create a character sprite
  getCharacterSprite(charKey, direction = 'down', scale = 1) {
    const charData = SPRITES.characters[charKey];
    if (!charData) return null;
    
    const frameData = charData[direction] || charData.down || charData;
    return this.createSprite(frameData, scale);
  }
  
  // Create an enemy sprite
  getEnemySprite(enemyKey, scale = 1) {
    const enemyData = SPRITES.enemies[enemyKey];
    if (!enemyData) return null;
    
    return this.createSprite(enemyData, scale);
  }
  
  // Create map monster sprite (smaller)
  getMapMonsterSprite(monsterKey, scale = 1) {
    const monsterData = SPRITES.mapMonsters[monsterKey];
    if (!monsterData) return null;
    
    return this.createSprite(monsterData, scale);
  }
  
  // Create a tile sprite
  getTileSprite(tileKey, scale = 1) {
    const tileData = SPRITES.tiles[tileKey];
    if (!tileData) return null;
    
    if (tileData.pattern) {
      return this.createSprite(tileData.pattern, scale);
    }
    return this.createSprite(tileData, scale);
  }
  
  // Generate a map background
  generateMapBackground(mapData, tileSize = 16) {
    const { w, h } = mapData.size;
    const canvas = document.createElement('canvas');
    canvas.width = w * tileSize;
    canvas.height = h * tileSize;
    const ctx = canvas.getContext('2d');
    
    ctx.imageSmoothingEnabled = false;
    
    // Determine tileset based on map type
    let floorTile, wallTile;
    switch(mapData.tileData) {
      case 'castle_inside':
        floorTile = this.getTileSprite('castle_floor');
        wallTile = this.getTileSprite('castle_wall');
        break;
      case 'throne':
        floorTile = this.getTileSprite('throne_floor');
        wallTile = this.getTileSprite('castle_wall');
        break;
      case 'town':
        floorTile = this.getTileSprite('town_floor');
        wallTile = this.getTileSprite('town_wall');
        break;
      case 'field':
        floorTile = this.getTileSprite('field_grass');
        wallTile = this.getTileSprite('field_tree');
        break;
      case 'tower_outside':
        floorTile = this.getTileSprite('field_grass');
        wallTile = this.getTileSprite('tower_wall');
        break;
      case 'tower_inside':
        floorTile = this.getTileSprite('tower_floor');
        wallTile = this.getTileSprite('tower_wall');
        break;
      default:
        floorTile = this.getTileSprite('grass');
        wallTile = this.getTileSprite('wall');
    }
    
    // Draw tiles
    for (let y = 0; y < h; y++) {
      for (let x = 0; x < w; x++) {
        const collision = mapData.collision[y]?.[x] || 0;
        const tile = collision === 1 ? wallTile : floorTile;
        
        if (tile) {
          ctx.drawImage(tile, x * tileSize, y * tileSize);
        }
      }
    }
    
    return canvas;
  }
}

// Export
window.SpriteRenderer = SpriteRenderer;
window.SPRITES = SPRITES;

// ============================================
// Sprite System - Better Backgrounds
// ============================================

const SPRITES = {
  characters: {
    hero: {
      down: ["0000033333300000" +
             "0003333333333000" +
             "0003CCCCCCCC3000" +
             "003CCC5555CCC300" +
             "03CCC511115CCC30" +
             "03CC5115511CCC30" +
             "03CC5111115CC300" +
             "03CCC555665CCC00" +
             "003CCC5555CC3000" +
             "0003AAAAAAAA3000" +
             "003AAAAAAAAAA300" +
             "003AAA3333AAA300" +
             "003AA333333AA300" +
             "0033333333333300" +
             "0003330000333000" +
             "0003330000333000"],
      up: ["0000033333300000" +
           "0003333333333000" +
           "0003CCCCCCCC3000" +
           "003CCCCCCCCCC300" +
           "03CCCCCCCCCCCC30" +
           "03CCCCCCCCCCCC30" +
           "03CCCCCCCCCCCC30" +
           "03CCCCCCCCCCCC30" +
           "003CCCCCCCCCC300" +
           "0003AAAAAAAA3000" +
           "003AAAAAAAAAA300" +
           "003AAA3333AAA300" +
           "003AA333333AA300" +
           "0033333333333300" +
           "0003330000333000" +
           "0003330000333000"],
      left: ["0000333333000000" +
             "0003333333330000" +
             "0003CCCCCCC30000" +
             "003CCC5555CC3000" +
             "03CCC51111CCC300" +
             "03CC511551CCC300" +
             "03CC511115CC3000" +
             "03CCC55665CC3000" +
             "003CCC5555C30000" +
             "0003AAAAAAA30000" +
             "003AAAAAAAAA3000" +
             "003AAA333AAA3000" +
             "003AA33333AA3000" +
             "0033333333330000" +
             "0033300003330000" +
             "0033300003330000"],
      right: ["0000003333330000" +
              "0000333333333000" +
              "00003CCCCCCC3000" +
              "0003CC5555CCC300" +
              "003CCC11115CCC30" +
              "003CCC15511CC30" +
              "0003CC51111CC300" +
              "0003CC56655CCC30" +
              "00003C5555CCC300" +
              "00003AAAAAAA3000" +
              "0003AAAAAAAAA300" +
              "0003AAA333AAA300" +
              "003AA33333AA3000" +
              "0000333333333300" +
              "0000333000033300" +
              "0000333000033300"]
    },
    
    king: {
      down: ["00CCC0000CCC0000" +
             "0CCCCCCCCCCC0000" +
             "CCCC555555CCCC00" +
             "CCC5555555555C00" +
             "0C55551111555C00" +
             "0C55511551155C00" +
             "0C55511111555C00" +
             "00C555666555C000" +
             "000C5555555C0000" +
             "000FF555555F0000" +
             "00FFFFFFFFFFFF00" +
             "00FF66666666FF00" +
             "000FFFFFFFFFF000" +
             "000FF000000FF000" +
             "000FF000000FF000" +
             "0000000000000000"]
    },
    
    princess: {
      down: ["000EEEEEEEE00000" +
             "00EEEEEEEEEEE000" +
             "0EEE5555555EE000" +
             "0EE555555555E000" +
             "0E5551111155E000" +
             "0E5511551155E000" +
             "0E5551111555E000" +
             "00E555666555E000" +
             "00EE5555555E0000" +
             "000EEEEEEEEE0000" +
             "00EEEEEEEEEE0000" +
             "00EE55555555E000" +
             "00E5555555555E00" +
             "000E555555555000" +
             "000EE00000EE0000" +
             "000EE00000EE0000"]
    },
    
    guard: {
      down: ["0000444444400000" +
             "0004444444444000" +
             "0004422222244000" +
             "0044225555224400" +
             "0442251111522440" +
             "0442511551154400" +
             "0442511111522400" +
             "0044225552224000" +
             "0004422222240000" +
             "0004474444740000" +
             "0044777777774000" +
             "0477777777777400" +
             "0477770007777400" +
             "0047770000777000" +
             "0004770000770000" +
             "0004770000770000"]
    },
    
    villager: {
      down: ["0000077777700000" +
             "0007777777777000" +
             "0007755555577000" +
             "0077555555557700" +
             "0775551111555770" +
             "0775511551155770" +
             "0775511111557700" +
             "0077555665557000" +
             "0007755555770000" +
             "0007999999970000" +
             "0079999999997000" +
             "0799999999999700" +
             "0799990009999700" +
             "0079990000999000" +
             "0007990000990000" +
             "0007990000990000"]
    },
    
    oldman: {
      down: ["0000555555500000" +
             "0005555555555000" +
             "0055555555555500" +
             "0555555555555550" +
             "0555551111555550" +
             "0555511551155550" +
             "0555511111555500" +
             "0555553335555000" +
             "0055555555550000" +
             "0005555555500000" +
             "0055577775550000" +
             "0557777777755000" +
             "0557770007755000" +
             "0055770000750000" +
             "0005770000700000" +
             "0005770000700000"]
    },
    
    cat: {
      down: ["0000000000000000" +
             "0DD00000000DD000" +
             "0DDD000000DDD000" +
             "0DDDDDDDDDDD0000" +
             "0DD1DD00DD1D0000" +
             "0DDDDDDDDDD00000" +
             "0DDD66DD66D00000" +
             "0DDDDDDDDD000000" +
             "00DDDDDDD0000000" +
             "000DDDDD00000000" +
             "0000DDD000000000" +
             "00DDDDDDD0000000" +
             "0DDDDDDDDD000000" +
             "0DDD000DDD000000" +
             "0000000000000000" +
             "0000000000000000"]
    }
  },
  
  enemies: {
    slime: ["0000000000000000" +
            "0000088888800000" +
            "0008888888888000" +
            "0088888888888800" +
            "0888855555588880" +
            "0888815551588880" +
            "0888885558888880" +
            "8888888888888888" +
            "8888888888888888" +
            "8888888888888888" +
            "8888888888888888" +
            "0888888888888880" +
            "0088888888888800" +
            "0008888888888000" +
            "0000888888880000" +
            "0000000000000000"],
    
    goblin: ["0000099999900000" +
             "0009999999990000" +
             "0099555555990000" +
             "0995551115559000" +
             "0995115515159900" +
             "0995111111559000" +
             "0099555665990000" +
             "0009955559900000" +
             "0009999999990000" +
             "0009933339990000" +
             "0099933339990000" +
             "0993333333990000" +
             "0993330033990000" +
             "0099330033900000" +
             "0009930039900000" +
             "0000990009900000"],
    
    skeleton: ["0000055555500000" +
               "0005555555550000" +
               "0055511111555000" +
               "0551111111155000" +
               "0551011110155000" +
               "0551166611155000" +
               "0055111111550000" +
               "0005555555500000" +
               "0000555555000000" +
               "0055555555550000" +
               "0505555555505000" +
               "0005555555500000" +
               "0000555555000000" +
               "0000555555000000" +
               "0000550055000000" +
               "0000550055000000"],
    
    dark_knight: ["0000022222200000" +
                  "0002222222222000" +
                  "0002211111122000" +
                  "0022116661112200" +
                  "0221166666112220" +
                  "0221111111112220" +
                  "0022222222222200" +
                  "0002222222222000" +
                  "0022222222222200" +
                  "0222224444222220" +
                  "2222244444422222" +
                  "2222444444442222" +
                  "0224444444442200" +
                  "0024440004442000" +
                  "0002440000440000" +
                  "0002440000440000"]
  },
  
  tiles: {
    // ===== 村の地面（石畳）=====
    stone: ["4444344434443444" +
            "4555455545554555" +
            "4555455545554555" +
            "3444344434443444" +
            "4445444454444544" +
            "4555455545554555" +
            "4555455545554555" +
            "3444344434443444" +
            "4444344434443444" +
            "4555455545554555" +
            "4555455545554555" +
            "3444344434443444" +
            "4445444454444544" +
            "4555455545554555" +
            "4555455545554555" +
            "3444344434443444"],
    
    // ===== 村の建物（壁）=====
    wall: ["7777777777777777" +
           "7555555555555557" +
           "7555555555555557" +
           "7555577775555557" +
           "7555577775555557" +
           "7555577775555557" +
           "7555555555555557" +
           "7777777777777777" +
           "7777777777777777" +
           "7555555555555557" +
           "7555577775555557" +
           "7555577775555557" +
           "7555577775555557" +
           "7555555555555557" +
           "7555555555555557" +
           "7777777777777777"],
    
    // ===== 草原 =====
    grass: ["8888988898888888" +
            "8988898888889888" +
            "8888888898888988" +
            "8988988888988888" +
            "8898888888888898" +
            "8888888988888888" +
            "8888988888988888" +
            "8888888888888988" +
            "8988988888888888" +
            "8888888888898888" +
            "8898888988888888" +
            "8888888888888898" +
            "8888888988888888" +
            "8988888888988888" +
            "8888988888898898" +
            "8888898888888888"],
    
    // ===== 木 =====
    tree: ["0000888888880000" +
           "0088888888888800" +
           "0888889889888880" +
           "8888889889888888" +
           "8888888888888888" +
           "8888888888888888" +
           "0888888888888880" +
           "0088888888888800" +
           "0000777777770000" +
           "0000077777700000" +
           "0000007777000000" +
           "0000007777000000" +
           "0000007777000000" +
           "0000007777000000" +
           "0000077777700000" +
           "0000777777770000"],
    
    // ===== 城内（床）=====
    floor: ["7774777477747774" +
            "7747774777477747" +
            "7477747774777477" +
            "4777477747774777" +
            "7774777477747774" +
            "7747774777477747" +
            "7477747774777477" +
            "4777477747774777" +
            "7774777477747774" +
            "7747774777477747" +
            "7477747774777477" +
            "4777477747774777" +
            "7774777477747774" +
            "7747774777477747" +
            "7477747774777477" +
            "4777477747774777"],
    
    // ===== 城壁 =====
    castle_wall: ["3333333333333333" +
                  "3222222222222223" +
                  "3222222222222223" +
                  "3222233332222223" +
                  "3222233332222223" +
                  "3222233332222223" +
                  "3222222222222223" +
                  "3333333333333333" +
                  "3333333333333333" +
                  "3222222222222223" +
                  "3222233332222223" +
                  "3222233332222223" +
                  "3222233332222223" +
                  "3222222222222223" +
                  "3222222222222223" +
                  "3333333333333333"],
    
    // ===== 城外（石畳）=====
    castle_ground: ["4343434343434343" +
                    "3434343434343434" +
                    "4343434343434343" +
                    "3434343434343434" +
                    "4343434343434343" +
                    "3434343434343434" +
                    "4343434343434343" +
                    "3434343434343434" +
                    "4343434343434343" +
                    "3434343434343434" +
                    "4343434343434343" +
                    "3434343434343434" +
                    "4343434343434343" +
                    "3434343434343434" +
                    "4343434343434343" +
                    "3434343434343434"],
    
    // ===== 塔（床）=====
    tower_floor: ["2323232323232323" +
                  "3212121212121213" +
                  "2121212121212132" +
                  "3212121212121213" +
                  "2121212121212132" +
                  "3212121212121213" +
                  "2121212121212132" +
                  "2323232323232323" +
                  "2323232323232323" +
                  "3212121212121213" +
                  "2121212121212132" +
                  "3212121212121213" +
                  "2121212121212132" +
                  "3212121212121213" +
                  "2121212121212132" +
                  "2323232323232323"],
    
    // ===== 塔（壁）=====
    tower_wall: ["1212121212121212" +
                 "2121323232312121" +
                 "1213232323231212" +
                 "2132322223231212" +
                 "1232322223232121" +
                 "2132322223231212" +
                 "1213232323231212" +
                 "1212121212121212" +
                 "1212121212121212" +
                 "2121323232312121" +
                 "1213232323231212" +
                 "2132322223231212" +
                 "1232322223232121" +
                 "2132322223231212" +
                 "1213232323231212" +
                 "1212121212121212"],
    
    // ===== ツボ =====
    pot: ["0000000000000000" +
          "0000044444400000" +
          "0000444444440000" +
          "0004477777744000" +
          "0047777777774000" +
          "0477777777777400" +
          "0477777777777400" +
          "0477777777777400" +
          "0477777777777400" +
          "0477777777777400" +
          "0477777777777400" +
          "0047777777774000" +
          "0004477777440000" +
          "0000444444400000" +
          "0000000000000000" +
          "0000000000000000"],
    
    // ===== 宝箱 =====
    chest: ["0000000000000000" +
            "00CCCCCCCCCCCC00" +
            "0CCCCCCCCCCCCCC0" +
            "0CDDDDDDDDDDDC0" +
            "0CDDDDCCDDDDDC0" +
            "CCCCCCCCCCCCCCCC" +
            "C777777777777777C" +
            "C777777CC7777777C" +
            "C777777CC7777777C" +
            "C77777CCCC777777C" +
            "C777777CC7777777C" +
            "C777777777777777C" +
            "C777777777777777C" +
            "CCCCCCCCCCCCCCCC" +
            "0000000000000000" +
            "0000000000000000"],
    
    // ===== キラキラ =====
    sparkle: ["0000000C00000000" +
              "000000CCC0000000" +
              "0000000C00000000" +
              "0000000000000000" +
              "00C000000000C000" +
              "0CCC0000000CCC00" +
              "00C000000000C000" +
              "0000000000000000" +
              "0000000000000000" +
              "00C000000000C000" +
              "0CCC0000000CCC00" +
              "00C000000000C000" +
              "0000000000000000" +
              "0000000C00000000" +
              "000000CCC0000000" +
              "0000000C00000000"],
    
    // ===== 出口矢印 =====
    exit_arrow: ["0000000CC0000000" +
                 "000000CCCC000000" +
                 "00000CCCCCC00000" +
                 "0000CCCCCCCC0000" +
                 "000CCCCCCCCCC000" +
                 "00CCCCCCCCCCCC00" +
                 "000000CCCC000000" +
                 "000000CCCC000000" +
                 "000000CCCC000000" +
                 "000000CCCC000000" +
                 "0000000000000000" +
                 "0000000000000000" +
                 "0000000000000000" +
                 "0000000000000000" +
                 "0000000000000000" +
                 "0000000000000000"],
    
    // ===== 城門（鍵穴付き）=====
    gate: ["2222222222222222" +
           "2777777777777772" +
           "2733333333333372" +
           "2733333333333372" +
           "2733377337733372" +
           "2733377337733372" +
           "273337CCC7333372" +
           "27333CCCCC333372" +
           "273337CCC7333372" +
           "2733377C77333372" +
           "2733377377333372" +
           "2733377377333372" +
           "2733377377333372" +
           "2733333333333372" +
           "2777777777777772" +
           "2222222222222222"],
    
    // ===== 玉座（王様用）=====
    throne: ["00CCCCCCCCCCCC00" +
             "0CCCCCCCCCCCCCC0" +
             "CCCC00000000CCCC" +
             "CCC0000000000CCC" +
             "CC000000000000CC" +
             "CC00FF0000FF00CC" +
             "CC00FF0000FF00CC" +
             "CC000000000000CC" +
             "0CC0000000000CC0" +
             "0CC0000000000CC0" +
             "00CCCCCCCCCCCC00" +
             "00CC77777777CC00" +
             "00CC77777777CC00" +
             "00CC77777777CC00" +
             "00CCCCCCCCCCCC00" +
             "0000CC0000CC0000"],
    
    // ===== 赤絨毯 =====
    carpet: ["6666666666666666" +
             "6CCCCCCCCCCCCCC6" +
             "6CCCCCCCCCCCCCC6" +
             "6666666666666666" +
             "6CCCCCCCCCCCCCC6" +
             "6CCCCCCCCCCCCCC6" +
             "6666666666666666" +
             "6CCCCCCCCCCCCCC6" +
             "6CCCCCCCCCCCCCC6" +
             "6666666666666666" +
             "6CCCCCCCCCCCCCC6" +
             "6CCCCCCCCCCCCCC6" +
             "6666666666666666" +
             "6CCCCCCCCCCCCCC6" +
             "6CCCCCCCCCCCCCC6" +
             "6666666666666666"],
    
    // ===== 家 =====
    house: ["0000077777700000" +
            "0007777777777000" +
            "0077777777777700" +
            "0777777777777770" +
            "7777777777777777" +
            "0077777777777700" +
            "0077555555557700" +
            "0077555555557700" +
            "0077555775557700" +
            "0077555775557700" +
            "0077555775557700" +
            "0077555775557700" +
            "0077555775557700" +
            "0077777777777700" +
            "0077777777777700" +
            "0077777777777700"],
    
    // ===== 井戸 =====
    well: ["0000033333300000" +
           "0003333333333000" +
           "0033344444433300" +
           "0034477777744300" +
           "0034478888744300" +
           "0034478888744300" +
           "0034478888744300" +
           "0034477777744300" +
           "0033344444433300" +
           "0003333333333000" +
           "0000333333300000" +
           "0000333333300000" +
           "0000077777000000" +
           "0000077777000000" +
           "0000077777000000" +
           "0000000000000000"],
    
    // ===== 花 =====
    flower: ["8888888888888888" +
             "888888E888888888" +
             "88888EEE88888888" +
             "888888E888888888" +
             "8888888888D88888" +
             "88888888888DD888" +
             "88888888888D8888" +
             "8888888888888888" +
             "88E8888888888888" +
             "8EEE888888888888" +
             "88E8888888888888" +
             "8888888888888888" +
             "8888888D88888888" +
             "888888DDD8888888" +
             "8888888D88888888" +
             "8888888888888888"],
    
    // ===== 道 =====
    path: ["7755775577557755" +
           "5577557755775577" +
           "7755775577557755" +
           "5577557755775577" +
           "7755775577557755" +
           "5577557755775577" +
           "7755775577557755" +
           "5577557755775577" +
           "7755775577557755" +
           "5577557755775577" +
           "7755775577557755" +
           "5577557755775577" +
           "7755775577557755" +
           "5577557755775577" +
           "7755775577557755" +
           "5577557755775577"],
    
    // ===== 水 =====
    water: ["AAAAAAAAAAAAAAAA" +
            "AABBABBABBABBABA" +
            "AAAAAAAAAAAAAAAA" +
            "ABABBABBABBABBAA" +
            "AAAAAAAAAAAAAAAA" +
            "AABBABBABBABBABA" +
            "AAAAAAAAAAAAAAAA" +
            "ABABBABBABBABBAA" +
            "AAAAAAAAAAAAAAAA" +
            "AABBABBABBABBABA" +
            "AAAAAAAAAAAAAAAA" +
            "ABABBABBABBABBAA" +
            "AAAAAAAAAAAAAAAA" +
            "AABBABBABBABBABA" +
            "AAAAAAAAAAAAAAAA" +
            "ABABBABBABBABBAA"]
  }
};

// Renderer
class SpriteRenderer {
  constructor() {
    this.cache = {};
  }
  
  getSprite(data, scale = 1) {
    const key = data + `-${scale}`;
    if (this.cache[key]) return this.cache[key];
    
    const size = 16;
    const canvas = document.createElement('canvas');
    canvas.width = size * scale;
    canvas.height = size * scale;
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    
    const colors = {
      "0": "transparent",
      "1": "#1a1a2e",      // Dark purple-black
      "2": "#3d3d5c",      // Dark gray-purple  
      "3": "#5a5a7a",      // Medium gray
      "4": "#8a8aa0",      // Light gray
      "5": "#ffe4c4",      // Skin/cream color
      "6": "#ff4444",      // Red (lips, damage)
      "7": "#a0522d",      // Brown (wood, buildings) - Sienna
      "8": "#32cd32",      // Lime green (grass)
      "9": "#228b22",      // Forest green
      "A": "#00bfff",      // Deep sky blue (water)
      "B": "#4169e1",      // Royal blue
      "C": "#ffd700",      // Gold/yellow
      "D": "#ff6600",      // Orange
      "E": "#ff69b4",      // Hot pink
      "F": "#9932cc"       // Dark orchid purple
    };
    
    for (let y = 0; y < size; y++) {
      for (let x = 0; x < size; x++) {
        const c = data[y * size + x];
        const col = colors[c];
        if (col && col !== "transparent") {
          ctx.fillStyle = col;
          ctx.fillRect(x * scale, y * scale, scale, scale);
        }
      }
    }
    
    this.cache[key] = canvas;
    return canvas;
  }
  
  getCharacterSprite(key, dir = 'down', scale = 1) {
    const data = SPRITES.characters[key]?.[dir];
    if (!data) return null;
    return this.getSprite(Array.isArray(data) ? data[0] : data, scale);
  }
  
  getEnemySprite(id, scale = 1) {
    const data = SPRITES.enemies[id];
    if (!data) return null;
    return this.getSprite(Array.isArray(data) ? data[0] : data, scale);
  }
  
  getTileSprite(id, scale = 1) {
    const data = SPRITES.tiles[id];
    if (!data) {
      console.warn('Tile not found:', id);
      return null;
    }
    return this.getSprite(data, scale);
  }
  
  generateMapBackground(map, scale = 2) {
    console.log('Generating background for:', map.name, 'tileData:', map.tileData);
    
    const size = 16;
    const canvas = document.createElement('canvas');
    canvas.width = map.size.w * size * scale;
    canvas.height = map.size.h * size * scale;
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    
    // Fill with base color first
    ctx.fillStyle = '#2d4a2d';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Map type → tiles
    let floorTile = 'stone';
    let wallTile = 'wall';
    let floorAlt = null;
    
    switch (map.tileData) {
      case 'field':
        floorTile = 'grass';
        floorAlt = 'flower';
        wallTile = 'tree';
        ctx.fillStyle = '#3cb371'; // Green base
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        break;
      case 'castle_inside':
        floorTile = 'floor';
        wallTile = 'castle_wall';
        ctx.fillStyle = '#5a4a3a'; // Brown base
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        break;
      case 'castle_outside':
        floorTile = 'castle_ground';
        wallTile = 'castle_wall';
        ctx.fillStyle = '#4a4a5a'; // Gray base
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        break;
      case 'tower_inside':
        floorTile = 'tower_floor';
        wallTile = 'tower_wall';
        ctx.fillStyle = '#1a1a2e'; // Dark base
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        break;
      case 'town':
      default:
        floorTile = 'stone';
        floorAlt = 'path';
        wallTile = 'house';
        ctx.fillStyle = '#6a6a7a'; // Gray stone base
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    console.log('Using floor:', floorTile, 'wall:', wallTile);
    
    // Draw base tiles
    for (let y = 0; y < map.size.h; y++) {
      for (let x = 0; x < map.size.w; x++) {
        const blocked = map.collision[y]?.[x] === 1;
        let tile = blocked ? wallTile : floorTile;
        
        // Add variety - some tiles use alternate floor
        if (!blocked && floorAlt && ((x + y) % 7 === 0)) {
          tile = floorAlt;
        }
        
        const spr = this.getTileSprite(tile, scale);
        if (spr) {
          ctx.drawImage(spr, x * size * scale, y * size * scale);
        }
      }
    }
    
    // Draw special decorations
    if (map.decorations) {
      for (const d of map.decorations) {
        const spr = this.getTileSprite(d.sprite, scale);
        if (spr) ctx.drawImage(spr, d.x * size * scale, d.y * size * scale);
      }
    }
    
    console.log('Background generated, size:', canvas.width, 'x', canvas.height);
    return canvas;
  }
}

window.SPRITES = SPRITES;
window.SpriteRenderer = SpriteRenderer;

// ============================================
// Sprite System - Pixel Art (16x16)
// With proper tile backgrounds
// ============================================

// Color palette:
// 0=transparent, 1=black, 2=dark gray, 3=gray, 4=light gray
// 5=skin/cream, 6=red, 7=brown, 8=green, 9=dark green
// A=blue, B=dark blue, C=yellow, D=orange, E=dark, F=purple

const SPRITES = {
  characters: {
    hero: {
      down: ["0000033333300000" +
             "0003333333333000" +
             "0003CCCCCCCC3000" +
             "003CCC3333CCC300" +
             "03CCC311113CCC30" +
             "03CC31551513CC30" +
             "03CC31511513CC30" +
             "03CCC311113CCC30" +
             "003CCC3663CCC300" +
             "0003AA3333AA3000" +
             "0003AAAAAAAA3000" +
             "003AAAA33AAAA300" +
             "003AAA3333AAA300" +
             "0033334433333300" +
             "0003333003333000" +
             "0003330000333000"],
      up: ["0000033333300000" +
           "0003333333333000" +
           "0003CCCCCCCC3000" +
           "003CCCCCCCCCC300" +
           "03CCCCCCCCCCCC30" +
           "03CCCCCCCCCCCC30" +
           "03CCCCCCCCCCCC30" +
           "03CCCCCCCCCCCC30" +
           "003CCCCCCCCCC300" +
           "0003AA3333AA3000" +
           "0003AAAAAAAA3000" +
           "003AAAA33AAAA300" +
           "003AAA3333AAA300" +
           "0033334433333300" +
           "0003333003333000" +
           "0003330000333000"],
      left: ["0000333333000000" +
             "0003333333330000" +
             "0003CCCCCCC30000" +
             "003CCC3333CC3000" +
             "03CCC31111CCC300" +
             "03CC3155151CC300" +
             "03CC3151151CC300" +
             "03CCC31111CCC300" +
             "003CCC3663CC3000" +
             "0003AA3333A30000" +
             "0003AAAAAAA30000" +
             "003AAAA33AAA3000" +
             "003AAA3333AA3000" +
             "0033344333330000" +
             "0033330033330000" +
             "0033300003330000"],
      right: ["0000003333330000" +
              "0000333333333000" +
              "00003CCCCCCC3000" +
              "0003CC3333CCC300" +
              "003CCC11113CCC30" +
              "003CC1515513CC30" +
              "003CC1511513CC30" +
              "003CCC11113CCC30" +
              "0003CC3663CCC300" +
              "00003A3333AA3000" +
              "00003AAAAAAA3000" +
              "0003AAA33AAAA300" +
              "003AA3333AAA3000" +
              "0000333344333300" +
              "0000333300333300" +
              "0000333000033300"]
    },
    
    king: {
      down: ["000CC00000CC0000" +
             "00CCCCCCCCCC0000" +
             "0CCCCCCCCCCCC000" +
             "CCCC55555555CC00" +
             "0CC5551111555C00" +
             "0C55515515155C00" +
             "0C55511111555C00" +
             "00C555666555C000" +
             "00CC5555555CC000" +
             "000CCCCCCCC00000" +
             "000FFFFFFFF00000" +
             "00FFFFFFFFFF0000" +
             "00FF666666FF0000" +
             "000FFFFFFFF00000" +
             "000FF0000FF00000" +
             "000FF0000FF00000"]
    },
    
    princess: {
      down: ["0000EEEEEE000000" +
             "000EEEEEEEE00000" +
             "00EEEEEEEEEE0000" +
             "0EEE55555555E000" +
             "0EE5551111555E00" +
             "0E5551551515E000" +
             "0E5551111155E000" +
             "00E555666555E000" +
             "00EE555555EE0000" +
             "000EEEEEEEE00000" +
             "00EEEEEEEEEE0000" +
             "00EE555555EE0000" +
             "00E55555555E0000" +
             "000EE5555EE00000" +
             "000E500005E00000" +
             "000E500005E00000"]
    },
    
    guard: {
      down: ["0000044444400000" +
             "0004444444444000" +
             "0004222222224000" +
             "0042225555222400" +
             "0422251111522240" +
             "0422515515152240" +
             "0422511111522400" +
             "0042225555222400" +
             "0004225555224000" +
             "0004444444440000" +
             "0044444444444000" +
             "0444447744444400" +
             "0444447744444400" +
             "0044444444444000" +
             "0004440000444000" +
             "0004440000444000"]
    },
    
    villager: {
      down: ["0000033333300000" +
             "0003333333333000" +
             "0003777777773000" +
             "0037775555777300" +
             "0377751111577730" +
             "0377515515157730" +
             "0377511111577300" +
             "0037775555777000" +
             "0003775555770000" +
             "0003999999930000" +
             "0039999999993000" +
             "0399999999999300" +
             "0399993333999300" +
             "0039993003999000" +
             "0003990000993000" +
             "0003990000993000"]
    },
    
    oldman: {
      down: ["0000055555500000" +
             "0005555555555000" +
             "0055555555555500" +
             "0555555555555550" +
             "0555551111555550" +
             "0555515515155550" +
             "0555511111555500" +
             "0555553333555000" +
             "0055555555550000" +
             "0005555555500000" +
             "0055577775550000" +
             "0557777777755000" +
             "0557773337755000" +
             "0055773037750000" +
             "0005770007700000" +
             "0005770007700000"]
    },
    
    cat: {
      down: ["0000000000000000" +
             "0000000000000000" +
             "0DD00000000DD000" +
             "0DDD000000DDD000" +
             "0DDDDDDDDDDD0000" +
             "0DD1DD00DD1DD000" +
             "0DDDDD00DDDDD000" +
             "0DDDD6DD6DDDD000" +
             "0DDDDDDDDDDD0000" +
             "00DDDDDDDDD00000" +
             "000DDDDDDD000000" +
             "0000DDDDD0000000" +
             "00DDDDDDDDD00000" +
             "0DDDDDDDDDDD0000" +
             "0DDDDD00DDDDD000" +
             "0000000000000000"]
    }
  },
  
  enemies: {
    slime: ["0000000000000000" +
            "0000088888800000" +
            "0008888888888000" +
            "0088888888888800" +
            "0888855885588880" +
            "0888815581588880" +
            "0888885588888880" +
            "8888888888888888" +
            "8888888888888888" +
            "8888888888888888" +
            "8888888888888888" +
            "0888888888888880" +
            "0088888888888800" +
            "0008888888888000" +
            "0000888888880000" +
            "0000000000000000"],
    
    goblin: ["0000099999900000" +
             "0009999999990000" +
             "0099555555990000" +
             "0995551115559000" +
             "0995115515159900" +
             "0995111111559000" +
             "0099555665990000" +
             "0009955559900000" +
             "0009999999990000" +
             "0009977779990000" +
             "0099977779990000" +
             "0997777777990000" +
             "0997770077990000" +
             "0099770077900000" +
             "0009970079900000" +
             "0000990009900000"],
    
    skeleton: ["0000055555500000" +
               "0005555555550000" +
               "0055511111555000" +
               "0551111111155000" +
               "0551011110155000" +
               "0551166611155000" +
               "0055111111550000" +
               "0005555555500000" +
               "0000555555000000" +
               "0055555555550000" +
               "0505555555505000" +
               "0005555555500000" +
               "0000555555000000" +
               "0000555555000000" +
               "0000550055000000" +
               "0000550055000000"],
    
    dark_knight: ["0000022222200000" +
                  "0002222222222000" +
                  "0002211111122000" +
                  "0022116661112200" +
                  "0221166666112220" +
                  "0221111111112220" +
                  "0022111111112200" +
                  "0002222222222000" +
                  "0022222222222200" +
                  "0222222222222220" +
                  "2222224444222222" +
                  "2222244444422222" +
                  "0222244444422220" +
                  "0022244444422200" +
                  "0002220002222000" +
                  "0002220002222000"]
  },
  
  tiles: {
    // Village/Town ground
    stone: ["4444444444444444" +
            "4555455545554555" +
            "4555455545554555" +
            "4444444444444444" +
            "5455455545544554" +
            "5455455545544554" +
            "4444444444444444" +
            "4555455545554555" +
            "4555455545554555" +
            "4444444444444444" +
            "5455455545544554" +
            "5455455545544554" +
            "4444444444444444" +
            "4555455545554555" +
            "4555455545554555" +
            "4444444444444444"],
    
    // Town wall/building
    wall: ["2222222222222222" +
           "2777777777777772" +
           "2777777777777772" +
           "2777777777777772" +
           "2222222222222222" +
           "7772277777722777" +
           "7772277777722777" +
           "7772277777722777" +
           "2222222222222222" +
           "2777777777777772" +
           "2777777777777772" +
           "2777777777777772" +
           "2222222222222222" +
           "7777722777772277" +
           "7777722777772277" +
           "2222222222222222"],
    
    // Grass field
    grass: ["8888888888888888" +
            "8988898888889888" +
            "8888888898888888" +
            "8888988888888888" +
            "8898888888888898" +
            "8888888988888888" +
            "8888888888988888" +
            "8888888888888888" +
            "8888988888888888" +
            "8888888888898888" +
            "8898888888888888" +
            "8888888888888898" +
            "8888888988888888" +
            "8888888888888888" +
            "8888888888898898" +
            "8888898888888888"],
    
    // Tree
    tree: ["0000088888880000" +
           "0008888888888800" +
           "0088888888888880" +
           "0888889889888880" +
           "8888889889888888" +
           "8888888888888888" +
           "0888888888888880" +
           "0088888888888800" +
           "0000777777770000" +
           "0000077777700000" +
           "0000007777000000" +
           "0000007777000000" +
           "0000007777000000" +
           "0000007777000000" +
           "0000077777700000" +
           "0000777777770000"],
    
    // Castle interior floor
    floor: ["4444444444444444" +
            "4777777777777774" +
            "4777777777777774" +
            "4777777777777774" +
            "4777777777777774" +
            "4777777777777774" +
            "4777777777777774" +
            "4444444444444444" +
            "4444444444444444" +
            "4777777777777774" +
            "4777777777777774" +
            "4777777777777774" +
            "4777777777777774" +
            "4777777777777774" +
            "4777777777777774" +
            "4444444444444444"],
    
    // Castle wall
    castle_wall: ["2222222222222222" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333222222333332" +
                  "2333222222333332" +
                  "2333222222333332" +
                  "2333333333333332" +
                  "2222222222222222" +
                  "2222222222222222" +
                  "2333333333333332" +
                  "2333222222333332" +
                  "2333222222333332" +
                  "2333222222333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2222222222222222"],
    
    // Tower floor
    tower_floor: ["2222222222222222" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2222222222222222" +
                  "2222222222222222" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2333333333333332" +
                  "2222222222222222"],
    
    // Tower wall
    tower_wall: ["1111111111111111" +
                 "1222222222222221" +
                 "1222222222222221" +
                 "1222111111222221" +
                 "1222111111222221" +
                 "1222111111222221" +
                 "1222222222222221" +
                 "1111111111111111" +
                 "1111111111111111" +
                 "1222222222222221" +
                 "1222111111222221" +
                 "1222111111222221" +
                 "1222111111222221" +
                 "1222222222222221" +
                 "1222222222222221" +
                 "1111111111111111"],
    
    // Castle outdoor
    castle_ground: ["4433443344334433" +
                    "4433443344334433" +
                    "3344334433443344" +
                    "3344334433443344" +
                    "4433443344334433" +
                    "4433443344334433" +
                    "3344334433443344" +
                    "3344334433443344" +
                    "4433443344334433" +
                    "4433443344334433" +
                    "3344334433443344" +
                    "3344334433443344" +
                    "4433443344334433" +
                    "4433443344334433" +
                    "3344334433443344" +
                    "3344334433443344"],
    
    // Items
    pot: ["0000000000000000" +
          "0000044444400000" +
          "0000444444440000" +
          "0004477777744000" +
          "0047777777774000" +
          "0477777777777400" +
          "0477777777777400" +
          "0477777777777400" +
          "0477777777777400" +
          "0477777777777400" +
          "0477777777777400" +
          "0047777777774000" +
          "0004477777440000" +
          "0000444444400000" +
          "0000000000000000" +
          "0000000000000000"],
    
    chest: ["0000000000000000" +
            "0077777777777000" +
            "0777777777777700" +
            "07DDDDDDDDDDD700" +
            "07DDDDDDDDDDD700" +
            "0777777777777700" +
            "07CCCCCCCCCCC700" +
            "07CCCCCCCCCCC700" +
            "07CCCCCCCCCCC700" +
            "07CCCCCDCCCCC700" +
            "07CCCCCCCCCCC700" +
            "07CCCCCCCCCCC700" +
            "0777777777777700" +
            "0077777777777000" +
            "0000000000000000" +
            "0000000000000000"],
    
    sparkle: ["0000000C00000000" +
              "000000CCC0000000" +
              "0000000C00000000" +
              "0000000000000000" +
              "00C000000000C000" +
              "0CCC0000000CCC00" +
              "00C000000000C000" +
              "0000000000000000" +
              "0000000000000000" +
              "00C000000000C000" +
              "0CCC0000000CCC00" +
              "00C000000000C000" +
              "0000000000000000" +
              "0000000C00000000" +
              "000000CCC0000000" +
              "0000000C00000000"],
    
    exit_arrow: ["0000000880000000" +
                 "0000008888000000" +
                 "0000088888800000" +
                 "0000888888880000" +
                 "0008888888888000" +
                 "0088888888888800" +
                 "0000008888000000" +
                 "0000008888000000" +
                 "0000008888000000" +
                 "0000008888000000" +
                 "0000008888000000" +
                 "0000008888000000" +
                 "0000008888000000" +
                 "0000008888000000" +
                 "0000000000000000" +
                 "0000000000000000"]
  }
};

// Sprite Renderer
class SpriteRenderer {
  constructor() {
    this.cache = {};
  }
  
  getSprite(spriteData, scale = 1) {
    const key = spriteData + `-${scale}`;
    if (this.cache[key]) return this.cache[key];
    
    const size = 16;
    const canvas = document.createElement('canvas');
    canvas.width = size * scale;
    canvas.height = size * scale;
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    
    const colors = {
      "0": "transparent",
      "1": "#111111",
      "2": "#333333",
      "3": "#555555",
      "4": "#777777",
      "5": "#EEDDCC",
      "6": "#FF4444",
      "7": "#885522",
      "8": "#44AA44",
      "9": "#337733",
      "A": "#4488FF",
      "B": "#2255AA",
      "C": "#FFCC00",
      "D": "#FF8800",
      "E": "#FF88AA",
      "F": "#8844AA"
    };
    
    for (let y = 0; y < size; y++) {
      for (let x = 0; x < size; x++) {
        const char = spriteData[y * size + x];
        const color = colors[char];
        if (color && color !== "transparent") {
          ctx.fillStyle = color;
          ctx.fillRect(x * scale, y * scale, scale, scale);
        }
      }
    }
    
    this.cache[key] = canvas;
    return canvas;
  }
  
  getCharacterSprite(spriteKey, direction = 'down', scale = 1) {
    const spriteData = SPRITES.characters[spriteKey]?.[direction];
    if (!spriteData) return null;
    return this.getSprite(spriteData[0] || spriteData, scale);
  }
  
  getEnemySprite(enemyId, scale = 1) {
    const spriteData = SPRITES.enemies[enemyId];
    if (!spriteData) return null;
    return this.getSprite(spriteData[0] || spriteData, scale);
  }
  
  getTileSprite(tileId, scale = 1) {
    const spriteData = SPRITES.tiles[tileId];
    if (!spriteData) return null;
    return this.getSprite(spriteData, scale);
  }
  
  generateMapBackground(mapData, scale = 2) {
    const tileSize = 16;
    const canvas = document.createElement('canvas');
    canvas.width = mapData.size.w * tileSize * scale;
    canvas.height = mapData.size.h * tileSize * scale;
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    
    // Determine tiles based on map type
    let floorTile = 'stone';
    let wallTile = 'wall';
    
    const tileData = mapData.tileData || 'town';
    
    switch (tileData) {
      case 'field':
        floorTile = 'grass';
        wallTile = 'tree';
        break;
      case 'castle_inside':
        floorTile = 'floor';
        wallTile = 'castle_wall';
        break;
      case 'castle_outside':
        floorTile = 'castle_ground';
        wallTile = 'castle_wall';
        break;
      case 'tower_inside':
        floorTile = 'tower_floor';
        wallTile = 'tower_wall';
        break;
      case 'town':
      default:
        floorTile = 'stone';
        wallTile = 'wall';
    }
    
    // Draw tiles
    for (let y = 0; y < mapData.size.h; y++) {
      for (let x = 0; x < mapData.size.w; x++) {
        const collision = mapData.collision[y]?.[x] || 0;
        const tileId = collision === 1 ? wallTile : floorTile;
        const sprite = this.getTileSprite(tileId, scale);
        if (sprite) {
          ctx.drawImage(sprite, x * tileSize * scale, y * tileSize * scale);
        }
      }
    }
    
    return canvas;
  }
}

window.SPRITES = SPRITES;
window.SpriteRenderer = SpriteRenderer;
